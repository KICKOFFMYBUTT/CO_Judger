# CO 自动评测机 开发笔记

在这里写自己给自己提出来的需求和开发日志

## 自动评测机 功能需求

### 自动运行

1. 支持采用不同的仿真工具进行评测。(目前本人电脑上安装的仿真工具有 iSim, iVerilog, ModelSim)
2. 可以定义一个接口类(Python里好像没有，那就用虚类或者虚方法)，约定自动运行的行为。
  - 这里先要求俩方法：读取 json 配置文件；自动运行
  - 读取配置：参数为一个 json 格式的配置文件，要求将配置文件中的配置选项解析出来并应用到类的成员中(这个方法也可以跟构造方法合并)
    - 配置文件要包含的信息：
    - 所用的仿真工具的路径
    - 调用仿真工具的命令(可以是多组命令)
    - 采用约定好的内部变量来标示：verilog 源文件位置，测试数据位置等(实际执行时替换成具体值)
  - 自动运行：根据配置中的路径和命令，命令行自动调用仿真软件，指定输出文件的路径，使仿真软件运行并将输出重定向到指定的输出文件中。
    - 将 Verilog 源代码文件(以压缩包打好)解压到评测机自己的临时目录下，要求顶层模块必须是 `mips.v` 。解压之后，
3. 对每一种仿真软件，继承上述的接口类，重载相关方法实现具体的自动运行行为。

### 输出比较

对写 GRF 和写 DM 的输出行为序列进行比较，时间戳忽略，返回一个评测信息和 Judger Comment (哪行不一样，哪条指令错了)
忽略向零号寄存器的一切写入行为。

### 测试数据

一个测试数据是一个文件夹，必须包含的要素有一个说明该组数据的 .json 文件，测试数据的机器码文件。可选要素有 .asm 汇编源代码文件， Mars 标准输出文件等。JSON 配置文件中要含有测试数据名称，机器码文件名，Mars 标准输出文件名等。(如果没有 Mars 标准输出，则这组测试数据仅能用于对拍，不能用于标准测试。若执行标准测试应给出提示，可采用测试数据辅助工具补全 Mars 的输出)

要有一个测试数据制作器类，提供 .asm 汇编文件，要能够利用 Mars 生成机器码以及标准的输出序列。

### 两种评测模式

对拍模式，标准输出模式。如果是对拍模式的话，需要指定两个版本 CPU 的源代码文件路径，测试数据只需要机器码。如果是标准模式，测试数据需要提供 Mars 输出。

### 全局设置

测试数据存放路径，verilog 解压后的源代码存放路径，已经支持的仿真软件配置，**是否开启了图形界面**，


### 新建评测任务

评测任务就是一个 json 文件，里边列举了评测采用的工具，所选用的测试数据，评测模式，

### 图形界面

分每个窗口介绍功能

#### Message 

有一个多行文本框(只读)，用于显示输出信息。
有一个 label 用于表示某个命令是成功执行还是失败执行。
提供一个关闭的方法，调用了可以关闭这个窗口。
全局通常只能有一个 Message 窗口。
构造时，将 IO 的引用标记指向自己；关闭时，释放掉 IO 引用，回归命令行。

#### Launcher 
最开始的主界面，提供如下的入口：
- 新建评测任务
- 打开评测任务
- 全局配置
- 测试数据辅助工具
- 退出

#### JudgeTask
显示评测任务的配置选项信息。
包括：评测模式，仿真工具选择，Verilog代码压缩包路径选择，测试数据选择。
按钮有 Run, Save, Quit

#### Setting
修改全局的配置。

#### TestCaseUtil
配置测试点名称，选择 asm 路径，Mars 路径(默认从全局设置里加载，可以在这里手动修改)，hex文件名，display文件名。
按钮：Load, Generate, Quit
- Load: 选择一个已经存好的测试数据配置 json 文件，加载到这个窗口中。
- Generate: 调用 Mars 补全hex和display的输出，并生成这组测试数据的 .json 文件。


### IO类

根据当前是否开启了图形界面，决定输出到哪里。
这个类里边有一个引用，如果为空则表示没开图形界面，直接输出到命令行。
如果这个引用指向了某个 Message 窗口，则向这个窗口输出。

### 日志功能

日志是个文本，每次评测就自动记录一条。每条评测信息包含：日期时间，仿真工具，评测模式，每组数据的评测结果。

### 顶层 Main

如果没有命令行参数，就启动图形界面。

命令行参数目前仅支持一种，就是 `-run [task.json]` ，运行一个写好的评测任务。

## 开发过程中遇到的问题

1. 所有在 `configs` 中的配置文件，路径一律是绝对路径或者相对于评测机主程序的路径
2. 测试数据的 `.json` 配置文件中，路径一律是相对测试数据的路径。
3. 程序里不用检查 `.json` 取出的字典里是否包含某个 key ，保证不会给出缺少必需 key 的 `.json` 。
4. 对于所需要的文件要在读取之前检查是否存在，如果不存在则输出错误信息。